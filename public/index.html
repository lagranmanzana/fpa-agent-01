<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Panel ventas • FPA Agent</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root { color-scheme: light dark; }
    body { font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Helvetica Neue', Arial; }
    .card { @apply bg-white/80 dark:bg-slate-800/80 backdrop-blur rounded-2xl shadow p-5 border border-slate-200 dark:border-slate-700; }
    .kpi { @apply text-slate-500 dark:text-slate-300 text-sm; }
    .kpi-value { @apply text-3xl font-semibold text-slate-900 dark:text-white; }
    .btn { @apply px-4 py-2 rounded-xl bg-slate-900 text-white hover:bg-slate-700 disabled:opacity-60; }
    .input { @apply px-3 py-2 rounded-xl border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900; }
    .grid-cards { @apply grid gap-4 md:grid-cols-3; }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-b from-slate-50 to-slate-100 dark:from-slate-900 dark:to-slate-950">
  <div class="max-w-7xl mx-auto px-4 py-8 space-y-6">
    <header class="flex items-center justify-between">
      <h1 class="text-2xl md:text-3xl font-bold text-slate-900 dark:text-white">
        BCEcopilot • Resumen de Ventas
      </h1>
      <div class="flex items-center gap-2">
        <input id="start" type="date" class="input" />
        <span class="text-slate-500 dark:text-slate-400">→</span>
        <input id="end" type="date" class="input" />
        <button id="loadBtn" class="btn">Actualizar</button>
      </div>
    </header>

    <!-- KPIs -->
    <section class="grid-cards">
      <div class="card">
        <div class="kpi">Ventas (EUR)</div>
        <div id="kpiTotal" class="kpi-value">—</div>
      </div>
      <div class="card">
        <div class="kpi">Pedidos</div>
        <div id="kpiOrders" class="kpi-value">—</div>
      </div>
      <div class="card">
        <div class="kpi">AOV (EUR)</div>
        <div id="kpiAOV" class="kpi-value">—</div>
      </div>
    </section>

    <!-- Gráfico -->
    <section class="card">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-lg font-semibold text-slate-900 dark:text-white">Ventas por día</h2>
      </div>
      <canvas id="salesChart" height="90"></canvas>
    </section>

    <!-- Informe ejecutivo -->
    <section class="card space-y-3">
      <h2 class="text-lg font-semibold text-slate-900 dark:text-white">Resumen ejecutivo</h2>
      <div id="summary" class="prose dark:prose-invert max-w-none">
        <em>Genera un resumen tras cargar los datos…</em>
      </div>
    </section>

    <!-- Preguntas al analista (ChatGPT) -->
    <section class="card space-y-3">
      <h2 class="text-lg font-semibold text-slate-900 dark:text-white">Consultas al analista</h2>
      <div class="flex gap-2">
        <input id="ask" class="input flex-1" placeholder="Ej.: ¿Cómo evoluciona el AOV vs la semana pasada?" />
        <button id="askBtn" class="btn">Preguntar</button>
      </div>
      <div id="askOut" class="text-slate-700 dark:text-slate-200"></div>
    </section>
  </div>

  <script>
    const SHEET = "OrdersTable";
    const fmt = (n) => new Intl.NumberFormat("es-ES", { style: "currency", currency: "EUR", maximumFractionDigits: 0 }).format(n || 0);
    const fmt2 = (n) => new Intl.NumberFormat("es-ES", { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(n || 0);

    const kpiTotal  = document.getElementById("kpiTotal");
    const kpiOrders = document.getElementById("kpiOrders");
    const kpiAOV    = document.getElementById("kpiAOV");
    const startEl   = document.getElementById("start");
    const endEl     = document.getElementById("end");
    const loadBtn   = document.getElementById("loadBtn");
    const summaryEl = document.getElementById("summary");
    const askEl     = document.getElementById("ask");
    const askBtn    = document.getElementById("askBtn");
    const askOut    = document.getElementById("askOut");

    // Por defecto últimos 30 días
    const today = new Date();
    const dEnd = today.toISOString().slice(0,10);
    const dStart = new Date(today.getTime() - 29*86400000).toISOString().slice(0,10);
    startEl.value = dStart;
    endEl.value = dEnd;

    let chart;
    function drawChart(data) {
      const ctx = document.getElementById("salesChart").getContext("2d");
      const labels = data.map(d => d.date);
      const values = data.map(d => d.value);
      if (chart) chart.destroy();
      chart = new Chart(ctx, {
        type: "line",
        data: {
          labels,
          datasets: [{
            label: "Ventas",
            data: values,
            tension: .35,
            borderWidth: 2,
            pointRadius: 0
          }]
        },
        options: {
          plugins: { legend: { display: false }},
          scales: {
            y: { ticks: { callback: (v) => fmt(v).replace(" ", " ") } }
          }
        }
      });
    }

    async function loadAll() {
      loadBtn.disabled = true;
      try {
        const start = startEl.value;
        const end = endEl.value;

        // KPIs
        const mRes = await fetch(`/metrics?sheet=${encodeURIComponent(SHEET)}&start=${start}&end=${end}`);
        const { ok: okM, metrics } = await mRes.json();
        if (okM) {
          kpiTotal.textContent  = fmt(metrics.totalSales);
          kpiOrders.textContent = metrics.orders ?? 0;
          kpiAOV.textContent    = fmt2(metrics.aov);
        }

        // Serie
        const tRes = await fetch(`/timeseries?sheet=${encodeURIComponent(SHEET)}&start=${start}&end=${end}`);
        const { ok: okT, timeseries } = await tRes.json();
        if (okT) drawChart(timeseries || []);

        // Informe ejecutivo
        const aRes = await fetch("/analyze-metrics", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ metrics, timeseries })
        });
        const aJson = await aRes.json();
        if (aJson.ok) {
          summaryEl.textContent = "";
          const p = document.createElement("div");
          p.className = "whitespace-pre-wrap";
          p.textContent = aJson.summary;
          summaryEl.appendChild(p);
        } else {
          summaryEl.textContent = aJson.error || "No se pudo generar el informe.";
        }
      } catch (e) {
        console.error(e);
        summaryEl.textContent = "Error cargando datos.";
      } finally {
        loadBtn.disabled = false;
      }
    }

    // Preguntas al analista (aprovechamos el mismo endpoint enviando prompt extra)
    async function askAnalyst() {
      const q = (askEl.value || "").trim();
      if (!q) return;
      askBtn.disabled = true;
      askOut.textContent = "Pensando…";
      try {
        const start = startEl.value;
        const end = endEl.value;

        const mRes = await fetch(`/metrics?sheet=${encodeURIComponent(SHEET)}&start=${start}&end=${end}`);
        const { metrics } = await mRes.json();

        const tRes = await fetch(`/timeseries?sheet=${encodeURIComponent(SHEET)}&start=${start}&end=${end}`);
        const { timeseries } = await tRes.json();

        const aRes = await fetch("/analyze-metrics", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ metrics, timeseries, userPrompt: q })
        });
        const aJson = await aRes.json();
        askOut.textContent = aJson.ok ? aJson.summary : (aJson.error || "No se pudo responder.");
      } catch (e) {
        console.error(e);
        askOut.textContent = "Error procesando la pregunta.";
      } finally {
        askBtn.disabled = false;
      }
    }

    loadBtn.addEventListener("click", loadAll);
    askBtn.addEventListener("click", askAnalyst);

    // Primer render
    loadAll();
  </script>
</body>
</html>

